import*as fs from"fs";import*as path from"path";import axios from"axios";import axiosRetry from"axios-retry";import qs from"qs";import{isUndefined}from"lodash-es";axiosRetry(axios,3);let city="",town="",interval=2e3;const _url="https://api.map.com.tw/net/familyShop.aspx",_root=["台北市","基隆市","新北市","桃園市","新竹市","新竹縣","苗栗縣","台中市","彰化縣","南投縣","雲林縣","嘉義市","嘉義縣","台南市","高雄市","屏東縣","宜蘭縣","花蓮縣","台東縣","澎湖縣","連江縣","金門縣"].map((t=>({label:t,value:t,city:t,children:[]})));async function requesDispatcher(t,{city:e,town:o}){let n=null;switch(!0){case!isUndefined(o):console.warn(`开始获取 ${e} - ${o} 的店铺地址`),n=await GetShop(e,o);break;case!isUndefined(e):console.warn(`开始获取 ${e} 的下属地区`),n=await GetTown(e)}return n&&(t.children=n),n}async function requestHandler(options,callback){return new Promise((resolve=>{setTimeout((async function(){const{status:status,data:data}=await axios.post(_url,qs.stringify(options),{headers:{Host:"api.map.com.tw","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.5005.63 Safari/537.36",Referer:"https://www.family.com.tw/"}}).catch((t=>{}));if(200!==status)throw new Error(`${options.city}-${options.town} 请求错误.`);{const res=eval(`function ${options.fun}(res){return res} ${data}`);resolve(res.map(callback))}}),interval)}))}async function GetTown(t){const e={searchType:"ShowTownList",type:"",city:t,fun:"storeTownList",key:"6F30E8BF706D653965BDE302661D1241F8BE9EBC"};return await requestHandler(e,(t=>({label:t.town,value:t.town,town:t.town,children:[]})))}async function GetShop(t,e){const o={searchType:"ShopList",type:"",city:t,area:e,road:"",fun:"showStoreList",key:"6F30E8BF706D653965BDE302661D1241F8BE9EBC"};return(await requestHandler(o,(t=>t))).reduce(((t,e)=>{const o={label:`${e.NAME} ${e.addr}`,value:`${e.NAME} ${e.addr}`},n=t.find((t=>t.value===e.road));return n?n.children.push(o):t.push({label:e.road,value:e.road,children:[o]}),t}),[])}(function t(e,o){const n=e.map(((e,i)=>async function(){city=isUndefined(e.city)?city:e.city,town=isUndefined(e.city)?e.town?e.town:town:void 0;const a=await requesDispatcher(e,{city:city,town:town});a[0]&&!isUndefined(a[0].children)&&!o&&await t(a,o+1)[0]();const s=n[++i];o||fs.writeFileSync(path.resolve(process.cwd(),`./dist/${city}.json`),JSON.stringify(e)),s&&await s()}));return n})(_root,0)[0]();
